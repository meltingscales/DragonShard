<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DragonShard Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dragon-dark': '#0f1419',
                        'dragon-card': '#1a1f2e',
                        'dragon-border': '#2d3748',
                        'dragon-primary': '#667eea',
                        'dragon-secondary': '#764ba2',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dragon-dark text-white">
    <div id="app">
        <!-- Header -->
        <header class="bg-gradient-to-r from-dragon-primary to-dragon-secondary p-6">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-4xl font-bold mb-2">üêâ DragonShard Visualization</h1>
                <p class="text-lg opacity-90">Real-time attack monitoring and network analysis</p>
                <div class="flex items-center mt-4">
                    <div id="wsStatus" class="w-3 h-3 rounded-full mr-2 bg-red-400"></div>
                    <span class="text-sm" id="wsStatusText">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto p-6">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Attack Stats -->
                <div class="bg-dragon-card border border-dragon-border rounded-lg p-6">
                    <h3 class="text-dragon-primary font-semibold mb-4">‚öîÔ∏è Attack Statistics</h3>
                    <div id="attackStats" class="grid grid-cols-2 gap-4">
                        <div class="text-center text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Vulnerability Stats -->
                <div class="bg-dragon-card border border-dragon-border rounded-lg p-6">
                    <h3 class="text-dragon-primary font-semibold mb-4">üõ°Ô∏è Vulnerability Summary</h3>
                    <div id="vulnStats" class="grid grid-cols-2 gap-4">
                        <div class="text-center text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Network Stats -->
                <div class="bg-dragon-card border border-dragon-border rounded-lg p-6">
                    <h3 class="text-dragon-primary font-semibold mb-4">üåê Network Topology</h3>
                    <div id="networkStats" class="grid grid-cols-2 gap-4">
                        <div class="text-center text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Fuzzing Stats -->
                <div class="bg-dragon-card border border-dragon-border rounded-lg p-6">
                    <h3 class="text-dragon-primary font-semibold mb-4">üß¨ Genetic Algorithm</h3>
                    <div id="fuzzingStats" class="grid grid-cols-2 gap-4">
                        <div class="text-center text-gray-400">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Active Attacks -->
            <div class="bg-dragon-card border border-dragon-border rounded-lg p-6 mb-6">
                <h3 class="text-dragon-primary font-semibold mb-4">üî• Active Attacks</h3>
                <div id="activeAttacks" class="text-center text-gray-400">Loading...</div>
            </div>

            <!-- Network Graph -->
            <div class="bg-dragon-card border border-dragon-border rounded-lg p-6">
                <h3 class="text-dragon-primary font-semibold mb-4">üó∫Ô∏è Network Graph</h3>
                <div id="networkGraph" class="h-96 bg-dragon-dark border border-dragon-border rounded-lg">
                    <div class="text-center text-gray-400 py-8">Loading network topology...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api/v1';
        const WS_URL = 'ws://localhost:8000/ws';
        
        // Global state
        let ws = null;
        let isConnected = false;

        // WebSocket connection
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    isConnected = true;
                    updateWSStatus(true);
                    
                    // Subscribe to all data streams
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        stream: 'attacks'
                    }));
                };
                
                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    isConnected = false;
                    updateWSStatus(false);
                    
                    // Reconnect after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    isConnected = false;
                    updateWSStatus(false);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                updateWSStatus(false);
            }
        }

        function updateWSStatus(connected) {
            const statusEl = document.getElementById('wsStatus');
            const textEl = document.getElementById('wsStatusText');
            if (connected) {
                statusEl.className = 'w-3 h-3 rounded-full mr-2 bg-green-400';
                textEl.textContent = 'Connected';
            } else {
                statusEl.className = 'w-3 h-3 rounded-full mr-2 bg-red-400';
                textEl.textContent = 'Disconnected';
            }
        }

        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);
            
            switch (message.type) {
                case 'attack_created':
                case 'attack_status_updated':
                case 'attack_step_updated':
                    loadAttackStats();
                    loadActiveAttacks();
                    break;
                case 'vulnerability_discovered':
                    loadVulnStats();
                    break;
                case 'host_discovered':
                    loadNetworkStats();
                    break;
                case 'fuzzing_progress_updated':
                    loadFuzzingStats();
                    break;
            }
        }

        // API functions
        async function apiGet(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API error (${endpoint}):`, error);
                throw error;
            }
        }

        // Load attack statistics
        async function loadAttackStats() {
            try {
                const stats = await apiGet('/attacks/summary/stats');
                
                const statsEl = document.getElementById('attackStats');
                statsEl.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-dragon-primary">${stats.total_attacks}</div>
                        <div class="text-sm text-gray-400">Total Attacks</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">${stats.running_attacks}</div>
                        <div class="text-sm text-gray-400">Running</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400">${stats.completed_attacks}</div>
                        <div class="text-sm text-gray-400">Completed</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400">${stats.success_rate.toFixed(1)}%</div>
                        <div class="text-sm text-gray-400">Success Rate</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('attackStats').innerHTML = `
                    <div class="text-red-400">Failed to load attack statistics: ${error.message}</div>
                `;
            }
        }

        // Load vulnerability statistics
        async function loadVulnStats() {
            try {
                const stats = await apiGet('/vulnerabilities/summary');
                
                const statsEl = document.getElementById('vulnStats');
                statsEl.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-400">${stats.critical_count}</div>
                        <div class="text-sm text-gray-400">Critical</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-400">${stats.high_count}</div>
                        <div class="text-sm text-gray-400">High</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400">${stats.medium_count}</div>
                        <div class="text-sm text-gray-400">Medium</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">${stats.low_count}</div>
                        <div class="text-sm text-gray-400">Low</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('vulnStats').innerHTML = `
                    <div class="text-red-400">Failed to load vulnerability statistics: ${error.message}</div>
                `;
            }
        }

        // Load network statistics
        async function loadNetworkStats() {
            try {
                const topology = await apiGet('/network/topology');
                
                const statsEl = document.getElementById('networkStats');
                statsEl.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400">${topology.total_hosts}</div>
                        <div class="text-sm text-gray-400">Hosts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-400">${topology.total_services}</div>
                        <div class="text-sm text-gray-400">Services</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('networkStats').innerHTML = `
                    <div class="text-red-400">Failed to load network statistics: ${error.message}</div>
                `;
            }
        }

        // Load fuzzing statistics
        async function loadFuzzingStats() {
            try {
                const stats = await apiGet('/fuzzing/stats');
                
                const statsEl = document.getElementById('fuzzingStats');
                statsEl.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">${stats.active_sessions}</div>
                        <div class="text-sm text-gray-400">Active Sessions</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400">${stats.best_fitness.toFixed(2)}</div>
                        <div class="text-sm text-gray-400">Best Fitness</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('fuzzingStats').innerHTML = `
                    <div class="text-red-400">Failed to load fuzzing statistics: ${error.message}</div>
                `;
            }
        }

        // Load active attacks
        async function loadActiveAttacks() {
            try {
                const attacks = await apiGet('/attacks/current/running');
                
                const attacksEl = document.getElementById('activeAttacks');
                if (attacks.length === 0) {
                    attacksEl.innerHTML = '<div class="text-center text-gray-400 py-8">No active attacks</div>';
                    return;
                }
                
                attacksEl.innerHTML = attacks.map(attack => `
                    <div class="bg-dragon-dark border border-dragon-border rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-white">${attack.name}</h4>
                            <span class="px-2 py-1 rounded text-xs font-semibold bg-green-500">${attack.status}</span>
                        </div>
                        <p class="text-gray-400 text-sm mb-3">${attack.description}</p>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Progress: ${attack.completed_steps}/${attack.total_steps}</span>
                            <span class="text-yellow-400">${attack.success_rate.toFixed(1)}% success</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="bg-dragon-primary h-2 rounded-full transition-all duration-300" style="width: ${(attack.completed_steps / attack.total_steps) * 100}%"></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('activeAttacks').innerHTML = `
                    <div class="text-red-400">Failed to load active attacks: ${error.message}</div>
                `;
            }
        }

        // Initialize
        function init() {
            console.log('Initializing DragonShard Visualization...');
            
            // Load initial data
            loadAttackStats();
            loadVulnStats();
            loadNetworkStats();
            loadFuzzingStats();
            loadActiveAttacks();
            
            // Connect WebSocket
            connectWebSocket();
            
            // Refresh data every 30 seconds
            setInterval(() => {
                if (isConnected) {
                    loadAttackStats();
                    loadVulnStats();
                    loadNetworkStats();
                    loadFuzzingStats();
                    loadActiveAttacks();
                }
            }, 30000);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 